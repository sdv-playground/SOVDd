# Engine ECU DID Definitions
# Format: sovd-conv YAML definition file
#
# This file defines how to decode/encode DIDs for the engine ECU.
# Similar concept to DBC files but for UDS diagnostic data.

meta:
  name: Engine ECU
  version: "1.0"
  description: Standard engine control module DIDs

dids:
  # ===========================================================================
  # Scalar Values
  # ===========================================================================

  0xF405:
    name: Coolant Temperature
    description: Engine coolant temperature sensor
    type: uint8
    scale: 1.0
    offset: -40.0
    unit: °C
    min: -40
    max: 215

  0xF40C:
    name: Engine RPM
    description: Engine crankshaft rotational speed
    type: uint16
    scale: 0.25
    unit: rpm
    min: 0
    max: 16383

  0xF40D:
    name: Vehicle Speed
    type: uint8
    scale: 1.0
    unit: km/h
    min: 0
    max: 255

  0xF40F:
    name: Intake Air Temperature
    type: uint8
    scale: 1.0
    offset: -40.0
    unit: °C

  0xF411:
    name: Throttle Position
    type: uint8
    scale: 0.392156863  # 100/255
    unit: "%"
    precision: 1

  0xF42F:
    name: Fuel Level
    type: uint8
    scale: 0.392156863
    unit: "%"

  # ===========================================================================
  # Strings
  # ===========================================================================

  0xF190:
    name: VIN
    description: Vehicle Identification Number
    type: string
    length: 17

  0xF187:
    name: Part Number
    type: string
    length: 16

  0xF18C:
    name: ECU Serial Number
    type: string
    length: 20

  # ===========================================================================
  # Enum/State Values
  # ===========================================================================

  0xF404:
    name: Engine State
    description: Current engine operating state
    type: uint8
    enum:
      0: "Off"
      1: "Cranking"
      2: "Running"
      3: "Overrun"
      4: "Stalled"

  0xF412:
    name: Gear Position
    description: Current transmission gear
    type: uint8
    enum:
      0: "P"
      1: "R"
      2: "N"
      3: "D"
      4: "S"
      5: "L"
      15: "Unknown"

  0xF413:
    name: Fuel System Status
    type: uint8
    enum:
      0: "OpenLoopCold"
      1: "ClosedLoop"
      2: "OpenLoopLoad"
      4: "OpenLoopFault"
      8: "ClosedLoopFault"

  # ===========================================================================
  # Bitfield Values (Status Bytes)
  # ===========================================================================

  0xF410:
    name: Engine Status Flags
    description: Packed engine status bits
    type: uint8
    bits:
      - name: engine_running
        bit: 0
      - name: mil_on
        bit: 1
      - name: ac_request
        bit: 2
      - name: ac_compressor
        bit: 3
      - name: fuel_cutoff
        bit: 4
      - name: closed_loop
        bit: 5
      - name: overtemp
        bit: 6
      - name: limp_mode
        bit: 7

  0xF414:
    name: Transmission Status
    type: uint16
    bits:
      - name: torque_converter_locked
        bit: 0
      - name: shift_in_progress
        bit: 1
      - name: sport_mode
        bit: 2
      - name: current_gear
        bit: 4
        width: 4
        enum:
          0: "P"
          1: "R"
          2: "N"
          3: "1"
          4: "2"
          5: "3"
          6: "4"
          7: "5"
          8: "6"
      - name: requested_gear
        bit: 8
        width: 4

  # ===========================================================================
  # Arrays (1D)
  # ===========================================================================

  0xF420:
    name: Cylinder Temperatures
    description: Individual cylinder head temperatures
    type: uint8
    scale: 1.0
    offset: -40.0
    unit: °C
    array: 8

  0xF421:
    name: Wheel Speeds
    description: Individual wheel speed sensors
    type: uint16
    scale: 0.01
    unit: km/h
    array: 4
    labels: ["FL", "FR", "RL", "RR"]

  0xF422:
    name: Misfire Counts
    description: Misfire counter per cylinder
    type: uint16
    array: 8

  0xF423:
    name: Injector Pulse Width
    description: Fuel injector on-time per cylinder
    type: uint16
    scale: 0.001
    unit: ms
    array: 8
    labels: ["Cyl1", "Cyl2", "Cyl3", "Cyl4", "Cyl5", "Cyl6", "Cyl7", "Cyl8"]

  0xF424:
    name: Knock Sensor Levels
    description: Knock intensity per cylinder
    type: uint8
    array: 8
    labels: ["Cyl1", "Cyl2", "Cyl3", "Cyl4", "Cyl5", "Cyl6", "Cyl7", "Cyl8"]

  # ===========================================================================
  # Maps (2D Calibration Tables)
  # ===========================================================================

  0xF500:
    name: Fuel Injection Map
    description: Base fuel injection duration vs RPM and load
    type: uint16
    scale: 0.001
    unit: ms
    precision: 3
    map:
      rows: 16
      cols: 16
      row_axis:
        name: RPM
        unit: rpm
        breakpoints: [800, 1200, 1600, 2000, 2400, 2800, 3200, 3600, 4000, 4400, 4800, 5200, 5600, 6000, 6400, 7000]
      col_axis:
        name: Load
        unit: "%"
        breakpoints: [0, 5, 10, 15, 20, 30, 40, 50, 60, 70, 80, 90, 95, 100, 105, 110]

  0xF501:
    name: Ignition Timing Map
    description: Base ignition advance vs RPM and load
    type: int8
    scale: 0.5
    unit: "° BTDC"
    map:
      rows: 16
      cols: 16
      row_axis:
        name: RPM
        unit: rpm
        breakpoints: [800, 1200, 1600, 2000, 2400, 2800, 3200, 3600, 4000, 4400, 4800, 5200, 5600, 6000, 6400, 7000]
      col_axis:
        name: Load
        unit: "%"
        breakpoints: [0, 5, 10, 15, 20, 30, 40, 50, 60, 70, 80, 90, 95, 100, 105, 110]

  0xF502:
    name: Lambda Target Map
    description: Target air-fuel ratio vs RPM and load
    type: uint8
    scale: 0.00390625  # 1/256
    offset: 0.5
    unit: λ
    precision: 3
    map:
      rows: 8
      cols: 8
      row_axis:
        name: RPM
        unit: rpm
        breakpoints: [1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000]
      col_axis:
        name: Load
        unit: "%"
        breakpoints: [0, 15, 30, 45, 60, 75, 90, 100]

  # ===========================================================================
  # Histograms (Operating Statistics)
  # ===========================================================================

  0xF600:
    name: RPM Operating Histogram
    description: Cumulative operating time at each RPM range
    type: uint32
    unit: seconds
    histogram:
      bins: [0, 1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000]
      labels: ["idle", "low", "cruise", "mid", "high", "sport", "redline", "over"]
      axis_name: RPM
      axis_unit: rpm
      overflow: true

  0xF601:
    name: Temperature Histogram
    description: Operating time at each coolant temperature range
    type: uint32
    unit: seconds
    histogram:
      bins: [-40, -20, 0, 20, 40, 60, 80, 90, 100, 110, 120]
      axis_name: Coolant Temperature
      axis_unit: °C
      overflow: true

  0xF602:
    name: Speed Histogram
    description: Distance traveled at each speed range
    type: uint32
    scale: 0.1
    unit: km
    histogram:
      bins: [0, 30, 50, 80, 100, 120, 150, 180, 200]
      labels: ["city", "suburban", "highway", "fast", "autobahn", "very_fast", "track", "extreme"]
      axis_name: Vehicle Speed
      axis_unit: km/h

  # ===========================================================================
  # Bit-Packed Values (extraction with mask/shift)
  # ===========================================================================

  0xF430:
    name: O2 Sensor Bank 1 Voltage
    description: Extracted from packed sensor data (lower 12 bits)
    type: uint16
    scale: 0.001220703  # 5/4096
    unit: V
    bit_mask: 0x0FFF
    precision: 3

  0xF431:
    name: O2 Sensor Bank 1 Short Term Trim
    description: Extracted from upper nibble
    type: uint8
    scale: 0.78125  # 100/128
    offset: -100.0
    unit: "%"
    bit_mask: 0xF0
    bit_shift: 4

  # ===========================================================================
  # Little-Endian Values (for specific ECUs)
  # ===========================================================================

  0xF440:
    name: Odometer (Little-Endian)
    description: Total distance traveled (LE format)
    type: uint32
    byte_order: little
    scale: 0.1
    unit: km
